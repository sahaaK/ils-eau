<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILS - Intelligent Learning System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-red: #ff2d55;
            --primary-blue: #0077ff;
            --dark-bg: #0f0f1a;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dark-bg);
            color: white;
            overflow-x: hidden;
        }
        
        .glassy {
            background: rgba(15, 15, 26, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
        }
        
        .gradient-text {
            background: linear-gradient(90deg, var(--primary-red), var(--primary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .bubble {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 45, 85, 0.1);
            box-shadow: inset 0 0 25px rgba(255, 45, 85, 0.4);
            animation: float 15s infinite ease-in-out;
            z-index: -1;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }
        
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        .gradient-animate {
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .toast {
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
        }
        
        @keyframes toastIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes toastOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-20px);
                opacity: 0;
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 45, 85, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 45, 85, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 45, 85, 0);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden">
    <!-- Floating Bubbles Background -->
    <div id="bubbles"></div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 w-72"></div>
    
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 slide-in">
            <div>
                <h1 class="text-4xl font-bold gradient-text">ILS</h1>
                <p class="text-gray-400">Intelligent Learning System</p>
            </div>
            <div class="flex space-x-4">
                <button id="theme-toggle" class="glassy p-2 rounded-full hover:bg-gray-800 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
                <button id="user-menu" class="glassy p-2 rounded-full hover:bg-gray-800 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </button>
            </div>
        </header>
                
        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Class Management -->
                <div class="glassy rounded-xl p-6 slide-in" style="animation-delay: 0.1s;">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.025-3.5 4 4 0 011.025-3.5 4 4 0 011.025 3.5A6.97 6.97 0 0014 16c0 .34-.024.673-.07 1h-1.07z" />
                            <path d="M5 11a4 4 0 014-4v1a3 3 0 00-3 3H5z" />
                        </svg>
                        Class Management
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Create New Class</label>
                            <div class="flex">
                                <input id="new-class-name" type="text" class="flex-1 bg-gray-800 border border-gray-700 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Class name">
                                <button id="create-class-btn" class="gradient-bg text-white px-4 py-2 rounded-r-lg hover:opacity-90 transition">Create</button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Select Class</label>
                            <select id="class-select" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select a class</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Student Management -->
                <div id="student-section" class="glassy rounded-xl p-6 slide-in hidden" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                        Student Management
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Add Student</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <input id="new-student-id" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Student ID">
                                </div>
                                <div>
                                    <input id="new-student-name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Student name">
                                </div>
                            </div>
                            <button id="add-student-btn" class="w-full gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                Add Student
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Students in Class</label>
                            <div id="students-list" class="max-h-64 overflow-y-auto bg-gray-800 rounded-lg p-2 space-y-2">
                                <!-- Students will be listed here -->
                                <p class="text-gray-500 text-center py-4">No students added yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                    
            <!-- Main Content Area -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Exam Management -->
                <div id="exam-section" class="glassy rounded-xl p-6 slide-in hidden" style="animation-delay: 0.3s;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                            </svg>
                            Exam Management
                        </h2>
                        <button id="add-exam-btn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Add Exam
                        </button>
                    </div>
                    
                    <div id="exam-form-container" class="hidden mb-6">
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Exam Name</label>
                                    <input id="exam-name" type="text" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. Midterm Exam">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Exam Date</label>
                                    <input id="exam-date" type="date" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button id="cancel-exam-btn" class="px-4 py-2 border border-gray-600 rounded-lg hover:bg-gray-700 transition">Cancel</button>
                                <button id="save-exam-btn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">Save Exam</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="exams-list" class="space-y-2">
                        <!-- Exams will be listed here -->
                        <p class="text-gray-500 text-center py-4">No exams created yet</p>
                    </div>
                </div>
                
                <!-- Results Spreadsheet -->
                <div id="results-section" class="glassy rounded-xl p-6 slide-in hidden" style="animation-delay: 0.4s;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                            </svg>
                            Results Spreadsheet
                        </h2>
                        <div class="flex space-x-2">
                            <select id="exam-select" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select an exam</option>
                            </select>
                            <button id="save-results-btn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                Save
                            </button>
                        </div>
                    </div>
                    
                    <div id="results-container" class="overflow-x-auto">
                        <table id="results-table" class="w-full bg-gray-800 rounded-lg overflow-hidden">
                            <thead>
                                <tr class="gradient-bg">
                                    <th class="px-4 py-3 text-left">ID</th>
                                    <th class="px-4 py-3 text-left">Name</th>
                                    <!-- Dynamic columns will be added here -->
                                </tr>
                            </thead>
                            <tbody id="results-body">
                                <!-- Results will be populated here -->
                                <tr>
                                    <td colspan="2" class="text-center py-4 text-gray-500">Select a class and exam to view results</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-end">
                        <button id="add-column-btn" class="flex items-center text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded-lg transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Add Column
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Add Column Modal -->
    <div id="column-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glassy rounded-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Add New Column</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Column Name</label>
                    <input id="new-column-name" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. Math Score">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Column Type</label>
                    <select id="column-type" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="number">Number</option>
                        <option value="text">Text</option>
                        <option value="grade">Grade (A-F)</option>
                        <option value="percentage">Percentage</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button id="cancel-column-btn" class="px-4 py-2 border border-gray-600 rounded-lg hover:bg-gray-700 transition">Cancel</button>
                <button id="save-column-btn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">Add Column</button>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCBQMVj3pp_EjaAj6pTiG32xRBB7eVYPKM",
            authDomain: "eauils.firebaseapp.com",
            projectId: "eauils",
            storageBucket: "eauils.appspot.com",
            messagingSenderId: "318437093898",
            appId: "1:318437093898:web:9458db63b467f45887e5f3",
            measurementId: "G-X9NHX0N46R"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // DOM Elements
        const newClassNameInput = document.getElementById('new-class-name');
        const createClassBtn = document.getElementById('create-class-btn');
        const classSelect = document.getElementById('class-select');
        const studentSection = document.getElementById('student-section');
        const newStudentIdInput = document.getElementById('new-student-id');
        const newStudentNameInput = document.getElementById('new-student-name');
        const addStudentBtn = document.getElementById('add-student-btn');
        const studentsList = document.getElementById('students-list');
        const examSection = document.getElementById('exam-section');
        const addExamBtn = document.getElementById('add-exam-btn');
        const examFormContainer = document.getElementById('exam-form-container');
        const examNameInput = document.getElementById('exam-name');
        const examDateInput = document.getElementById('exam-date');
        const cancelExamBtn = document.getElementById('cancel-exam-btn');
        const saveExamBtn = document.getElementById('save-exam-btn');
        const examsList = document.getElementById('exams-list');
        const resultsSection = document.getElementById('results-section');
        const examSelect = document.getElementById('exam-select');
        const saveResultsBtn = document.getElementById('save-results-btn');
        const resultsTable = document.getElementById('results-table');
        const resultsBody = document.getElementById('results-body');
        const addColumnBtn = document.getElementById('add-column-btn');
        const columnModal = document.getElementById('column-modal');
        const newColumnNameInput = document.getElementById('new-column-name');
        const columnTypeSelect = document.getElementById('column-type');
        const cancelColumnBtn = document.getElementById('cancel-column-btn');
        const saveColumnBtn = document.getElementById('save-column-btn');
        const toastContainer = document.getElementById('toast-container');
        const bubblesContainer = document.getElementById('bubbles');
        
        // State
        let currentClassId = null;
        let currentExamId = null;
        let students = [];
        let exams = [];
        let results = {};
        let columns = ['id', 'name']; // Default columns
        
        // Create floating bubbles
        function createBubbles() {
            const bubbleCount = 15;
            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                
                // Random size between 50px and 150px
                const size = Math.random() * 100 + 50;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                
                // Random position
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.top = `${Math.random() * 100}%`;
                
                // Random animation delay
                bubble.style.animationDelay = `${Math.random() * 15}s`;
                
                bubblesContainer.appendChild(bubble);
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.classList.add('toast', 'glassy', 'p-3', 'rounded-lg', 'flex', 'items-center');

            let iconColor = 'text-blue-400';
            if (type === 'error') iconColor = 'text-red-400';
            if (type === 'warning') iconColor = 'text-yellow-400';

            toast.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${iconColor} mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <span>${message}</span>
            `;

            toastContainer.appendChild(toast);

            // Remove toast after animation
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Load classes from Firestore
        function loadClasses() {
            db.collection('classes').get()
                .then((querySnapshot) => {
                    classSelect.innerHTML = '<option value="">Select a class</option>';
                    querySnapshot.forEach((doc) => {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = doc.data().name;
                        classSelect.appendChild(option);
                    });
                })
                .catch((error) => {
                    showToast('Failed to load classes', 'error');
                    console.error("Error loading classes: ", error);
                });
        }
        
        // Create a new class
        function createClass() {
            const className = newClassNameInput.value.trim();
            if (!className) {
                showToast('Please enter a class name', 'warning');
                return;
            }
            
            db.collection('classes').add({
                name: className,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                showToast('Class created successfully');
                newClassNameInput.value = '';
                loadClasses();
            })
            .catch((error) => {
                showToast('Failed to create class', 'error');
                console.error("Error creating class: ", error);
            });
        }
        
        // Load students for selected class
        function loadStudents(classId) {
            studentsList.innerHTML = '<p class="text-gray-500 text-center py-4">Loading students...</p>';
            
            db.collection('classes').doc(classId).collection('students').orderBy('studentId').get()
                .then((querySnapshot) => {
                    students = [];
                    studentsList.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        studentsList.innerHTML = '<p class="text-gray-500 text-center py-4">No students added yet</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const student = {
                            id: doc.id,
                            ...doc.data()
                        };
                        students.push(student);
                        
                        const studentItem = document.createElement('div');
                        studentItem.classList.add('flex', 'justify-between', 'items-center', 'bg-gray-700', 'p-2', 'rounded-lg');
                        studentItem.innerHTML = `
                            <div>
                                <span class="font-medium text-blue-300">${student.studentId || 'N/A'}</span>
                                <span class="ml-2">${student.name}</span>
                            </div>
                            <button class="delete-student-btn text-red-400 hover:text-red-300" data-id="${doc.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        `;
                        
                        studentsList.appendChild(studentItem);
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-student-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const studentId = e.currentTarget.getAttribute('data-id');
                            deleteStudent(studentId);
                        });
                    });
                })
                .catch((error) => {
                    showToast('Failed to load students', 'error');
                    console.error("Error loading students: ", error);
                });
        }
        
        // Add a new student to the current class
        function addStudent() {
            const studentId = newStudentIdInput.value.trim();
            const studentName = newStudentNameInput.value.trim();
            
            if (!studentId) {
                showToast('Please enter a student ID', 'warning');
                return;
            }
            
            if (!studentName) {
                showToast('Please enter a student name', 'warning');
                return;
            }
            
            if (!currentClassId) {
                showToast('Please select a class first', 'warning');
                return;
            }
            
            // Check if student ID already exists
            db.collection('classes').doc(currentClassId).collection('students')
                .where('studentId', '==', studentId)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        showToast('Student ID already exists', 'error');
                        return;
                    }
                    
                    // Add the new student
                    return db.collection('classes').doc(currentClassId).collection('students').add({
                        studentId: studentId,
                        name: studentName,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showToast('Student added successfully');
                    newStudentIdInput.value = '';
                    newStudentNameInput.value = '';
                    loadStudents(currentClassId);
                })
                .catch((error) => {
                    showToast('Failed to add student', 'error');
                    console.error("Error adding student: ", error);
                });
        }
        
        // Delete a student
        function deleteStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student?')) return;
            
            db.collection('classes').doc(currentClassId).collection('students').doc(studentId).delete()
                .then(() => {
                    showToast('Student deleted successfully');
                    loadStudents(currentClassId);
                    
                    // Also delete any results for this student in all exams
                    if (exams.length > 0) {
                        const batch = db.batch();
                        
                        exams.forEach(exam => {
                            const resultRef = db.collection('classes').doc(currentClassId)
                                .collection('exams').doc(exam.id)
                                .collection('results').doc(studentId);
                            
                            batch.delete(resultRef);
                        });
                        
                        return batch.commit();
                    }
                })
                .then(() => {
                    // If we deleted the currently viewed student, reload results
                    if (currentExamId) {
                        loadResults(currentExamId);
                    }
                })
                .catch((error) => {
                    showToast('Failed to delete student', 'error');
                    console.error("Error deleting student: ", error);
                });
        }
        
        // Load exams for selected class
        function loadExams(classId) {
            examsList.innerHTML = '<p class="text-gray-500 text-center py-4">Loading exams...</p>';
            
            db.collection('classes').doc(classId).collection('exams').orderBy('date', 'desc').get()
                .then((querySnapshot) => {
                    exams = [];
                    examsList.innerHTML = '';
                    examSelect.innerHTML = '<option value="">Select an exam</option>';
                    
                    if (querySnapshot.empty) {
                        examsList.innerHTML = '<p class="text-gray-500 text-center py-4">No exams created yet</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const exam = {
                            id: doc.id,
                            ...doc.data()
                        };
                        exams.push(exam);
                        
                        // Add to exams list
                        const examItem = document.createElement('div');
                        examItem.classList.add('flex', 'justify-between', 'items-center', 'bg-gray-700', 'p-3', 'rounded-lg', 'mb-2');
                        examItem.innerHTML = `
                            <div>
                                <h3 class="font-medium">${exam.name}</h3>
                                <p class="text-sm text-gray-400">${new Date(exam.date.seconds * 1000).toLocaleDateString()}</p>
                            </div>
                            <button class="delete-exam-btn text-red-400 hover:text-red-300" data-id="${doc.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        `;
                        
                        examsList.appendChild(examItem);
                        
                        // Add to exam select dropdown
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = exam.name;
                        examSelect.appendChild(option);
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-exam-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const examId = e.currentTarget.getAttribute('data-id');
                            deleteExam(examId);
                        });
                    });
                })
                .catch((error) => {
                    showToast('Failed to load exams', 'error');
                    console.error("Error loading exams: ", error);
                });
        }
        
        // Add a new exam to the current class
        function addExam() {
            const examName = examNameInput.value.trim();
            const examDate = examDateInput.value;
            
            if (!examName) {
                showToast('Please enter an exam name', 'warning');
                return;
            }
            
            if (!examDate) {
                showToast('Please select an exam date', 'warning');
                return;
            }
            
            db.collection('classes').doc(currentClassId).collection('exams').add({
                name: examName,
                date: new Date(examDate),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                showToast('Exam added successfully');
                examNameInput.value = '';
                examDateInput.value = '';
                examFormContainer.classList.add('hidden');
                loadExams(currentClassId);
            })
            .catch((error) => {
                showToast('Failed to add exam', 'error');
                console.error("Error adding exam: ", error);
            });
        }
        
        // Delete an exam
        function deleteExam(examId) {
            if (!confirm('Are you sure you want to delete this exam? All associated results will also be deleted.')) return;
            
            // First delete all results for this exam
            db.collection('classes').doc(currentClassId).collection('exams').doc(examId).collection('results').get()
                .then((querySnapshot) => {
                    const batch = db.batch();
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    // Then delete the exam itself
                    return db.collection('classes').doc(currentClassId).collection('exams').doc(examId).delete();
                })
                .then(() => {
                    showToast('Exam deleted successfully');
                    loadExams(currentClassId);
                    
                    // If we deleted the currently selected exam, clear the results view
                    if (currentExamId === examId) {
                        currentExamId = null;
                        examSelect.value = '';
                        resultsBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Select a class and exam to view results</td></tr>';
                    }
                })
                .catch((error) => {
                    showToast('Failed to delete exam', 'error');
                    console.error("Error deleting exam: ", error);
                });
        }
        
        // Load results for selected exam
        function loadResults(examId) {
            resultsBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Loading results...</td></tr>';
            
            // First get the exam to check its columns
            db.collection('classes').doc(currentClassId).collection('exams').doc(examId).get()
                .then((examDoc) => {
                    const examData = examDoc.data();
                    columns = ['id', 'name'];
                    
                    if (examData.columns) {
                        columns = columns.concat(examData.columns);
                    }
                    
                    // Now get all results for this exam
                    return db.collection('classes').doc(currentClassId).collection('exams').doc(examId).collection('results').get();
                })
                .then((querySnapshot) => {
                    results = {};
                    querySnapshot.forEach((doc) => {
                        results[doc.id] = doc.data();
                    });
                    
                    renderResultsTable();
                })
                .catch((error) => {
                    showToast('Failed to load results', 'error');
                    console.error("Error loading results: ", error);
                });
        }
        
        // Render the results table
        function renderResultsTable() {
            // Clear the table
            resultsBody.innerHTML = '';
            
            // Rebuild the header with all columns
            const headerRow = resultsTable.querySelector('thead tr');
            headerRow.innerHTML = '';
            
            columns.forEach(col => {
                const th = document.createElement('th');
                th.classList.add('px-4', 'py-3', 'text-left');
                th.textContent = col.charAt(0).toUpperCase() + col.slice(1).replace(/([A-Z])/g, ' $1');
                
                // Make ID and Name columns non-removable
                if (col !== 'id' && col !== 'name') {
                    th.innerHTML += `
                        <button class="delete-column-btn ml-2 text-red-400 hover:text-red-300" data-col="${col}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                }
                
                headerRow.appendChild(th);
            });
            
            // Add event listeners to column delete buttons
            document.querySelectorAll('.delete-column-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const columnName = e.currentTarget.getAttribute('data-col');
                    deleteColumn(columnName);
                });
            });
            
            // Populate the table body with student data
            students.forEach(student => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-800');
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.classList.add('px-4', 'py-3');
                    
                    if (col === 'id') {
                        td.textContent = student.studentId || student.id;
                    } else if (col === 'name') {
                        td.textContent = student.name;
                    } else {
                        // Check if we have results for this student
                        if (results[student.id] && results[student.id][col] !== undefined) {
                            td.textContent = results[student.id][col];
                        } else {
                            // Create an input field for empty cells
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.classList.add('w-full', 'bg-gray-700', 'border', 'border-gray-600', 'rounded', 'px-2', 'py-1', 'focus:outline-none', 'focus:ring-1', 'focus:ring-blue-500');
                            input.value = '';
                            input.dataset.studentId = student.id;
                            input.dataset.column = col;
                            
                            // Add event listener to save on change
                            input.addEventListener('change', (e) => {
                                const studentId = e.target.dataset.studentId;
                                const column = e.target.dataset.column;
                                const value = e.target.value.trim();
                                
                                // Update local results
                                if (!results[studentId]) {
                                    results[studentId] = {};
                                }
                                results[studentId][column] = value;
                            });
                            
                            td.appendChild(input);
                        }
                    }
                    
                    row.appendChild(td);
                });
                
                resultsBody.appendChild(row);
            });
        }
        
        // Save all results to Firestore
        function saveResults() {
            if (!currentClassId || !currentExamId) {
                showToast('Please select a class and exam first', 'warning');
                return;
            }
            
            const batch = db.batch();
            let changesCount = 0;
            
            // Prepare all updates
            Object.keys(results).forEach(studentId => {
                const resultData = results[studentId];
                
                // Only save if there's actual data (not just ID and name)
                if (Object.keys(resultData).length > 0) {
                    const resultRef = db.collection('classes').doc(currentClassId)
                        .collection('exams').doc(currentExamId)
                        .collection('results').doc(studentId);
                    
                    batch.set(resultRef, resultData);
                    changesCount++;
                }
            });
            
            if (changesCount === 0) {
                showToast('No changes to save', 'warning');
                return;
            }
            
            // Commit the batch
            batch.commit()
                .then(() => {
                    showToast('Results saved successfully');
                })
                .catch((error) => {
                    showToast('Failed to save results', 'error');
                    console.error("Error saving results: ", error);
                });
        }
        
        // Add a new column to the exam
        function addColumn() {
            columnModal.classList.remove('hidden');
        }
        
        // Save the new column
        function saveColumn() {
            const columnName = newColumnNameInput.value.trim().toLowerCase().replace(/\s+/g, '_');
            
            if (!columnName) {
                showToast('Please enter a column name', 'warning');
                return;
            }
            
            if (columns.includes(columnName)) {
                showToast('Column already exists', 'warning');
                return;
            }
            
            // Add to local columns
            columns.push(columnName);
            
            // Update the exam document with the new columns list (excluding id and name)
            const examColumns = columns.filter(col => col !== 'id' && col !== 'name');
            
            db.collection('classes').doc(currentClassId).collection('exams').doc(currentExamId).update({
                columns: examColumns
            })
            .then(() => {
                showToast('Column added successfully');
                newColumnNameInput.value = '';
                columnModal.classList.add('hidden');
                renderResultsTable();
            })
            .catch((error) => {
                showToast('Failed to add column', 'error');
                console.error("Error adding column: ", error);
            });
        }
        
        // Delete a column from the exam
        function deleteColumn(columnName) {
            if (!confirm(`Are you sure you want to delete the "${columnName}" column? All data in this column will be lost.`)) return;
            
            // Remove from local columns
            columns = columns.filter(col => col !== columnName);
            
            // Update the exam document with the new columns list (excluding id and name)
            const examColumns = columns.filter(col => col !== 'id' && col !== 'name');
            
            db.collection('classes').doc(currentClassId).collection('exams').doc(currentExamId).update({
                columns: examColumns
            })
            .then(() => {
                // Also need to remove this column from all student results
                const batch = db.batch();
                
                Object.keys(results).forEach(studentId => {
                    if (results[studentId][columnName] !== undefined) {
                        const resultRef = db.collection('classes').doc(currentClassId)
                            .collection('exams').doc(currentExamId)
                            .collection('results').doc(studentId);
                        
                        batch.update(resultRef, {
                            [columnName]: firebase.firestore.FieldValue.delete()
                        });
                        
                        // Update local results
                        delete results[studentId][columnName];
                    }
                });
                
                return batch.commit();
            })
            .then(() => {
                showToast('Column deleted successfully');
                renderResultsTable();
            })
            .catch((error) => {
                showToast('Failed to delete column', 'error');
                console.error("Error deleting column: ", error);
            });
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            createBubbles();
            loadClasses();
            
            // Add animation class to all slide-in elements
            document.querySelectorAll('.slide-in').forEach((el, index) => {
                el.style.animationDelay = `${index * 0.1}s`;
            });
        });
        
        createClassBtn.addEventListener('click', createClass);
        
        classSelect.addEventListener('change', (e) => {
            currentClassId = e.target.value;
            
            if (currentClassId) {
                studentSection.classList.remove('hidden');
                examSection.classList.remove('hidden');
                resultsSection.classList.remove('hidden');
                
                loadStudents(currentClassId);
                loadExams(currentClassId);
                
                // Clear results view
                currentExamId = null;
                examSelect.value = '';
                resultsBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Select an exam to view results</td></tr>';
            } else {
                studentSection.classList.add('hidden');
                examSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
            }
        });
        
        addStudentBtn.addEventListener('click', addStudent);
        
        addExamBtn.addEventListener('click', () => {
            examFormContainer.classList.remove('hidden');
            examNameInput.focus();
        });
        
        cancelExamBtn.addEventListener('click', () => {
            examFormContainer.classList.add('hidden');
        });
        
        saveExamBtn.addEventListener('click', addExam);
        
        examSelect.addEventListener('change', (e) => {
            currentExamId = e.target.value;
            
            if (currentExamId) {
                loadResults(currentExamId);
            } else {
                resultsBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Select an exam to view results</td></tr>';
            }
        });
        
        saveResultsBtn.addEventListener('click', saveResults);
        
        addColumnBtn.addEventListener('click', addColumn);
        
        cancelColumnBtn.addEventListener('click', () => {
            columnModal.classList.add('hidden');
        });
        
        saveColumnBtn.addEventListener('click', saveColumn);
        
        // Allow pressing Enter in inputs to submit forms
        newClassNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createClass();
        });
        
        newStudentIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addStudent();
        });
        
        newStudentNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addStudent();
        });
                examNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addExam();
        });
        
        newColumnNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveColumn();
        });
    </script>
</body>
</html>